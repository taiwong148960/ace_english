---
alwaysApply: true
---

# Project Context & Deployment Rules

## 1. Infrastructure & Tech Stack
- **Code Hosting:** GitHub
- **Web Deployment:** Vercel
- **Desktop Build:** Tauri (cross-platform: Windows, macOS, Linux)
- **Backend/Database:** Supabase
- **Project Name/Context:** Ace IELTS

## 2. Deployment Modes

### SaaS Mode (Cloud-Hosted)
- **Target Users:** End users who want a ready-to-use service
- **Infrastructure:** Hosted on Vercel + Supabase Cloud
- **LLM API:** Managed by the platform (users pay subscription)
- **Database:** Shared Supabase instance with Row Level Security (RLS)

### Self-Hosted Mode (Open Source)
- **Target Users:** Developers, enterprises, privacy-conscious users
- **Infrastructure:** User deploys on their own servers or locally
- **LLM API:** User provides their own OpenAI-compatible API key
- **Database:** User's own Supabase instance or local PostgreSQL

## 3. Environments & URLs

| Environment | URL | Description |
| :--- | :--- | :--- |
| **Production (SaaS)** | `https://www.ace-ielts.net` | Live cloud service (Vercel) |
| **Development** | `http://localhost:3000` | Local web testing |
| **Desktop Dev** | `tauri dev` | Local desktop testing |

## 4. Environment Variables

### Common Variables (All Modes)
```env
VITE_SUPABASE_URL=<supabase_project_url>
VITE_SUPABASE_ANON_KEY=<supabase_anon_key>
```

### Deployment Mode Configuration
```env
# SaaS Mode
VITE_DEPLOYMENT_MODE=saas
VITE_LLM_API_KEY=<platform_managed_key>  # Server-side only

# Self-Hosted Mode
VITE_DEPLOYMENT_MODE=self-hosted
# LLM_API_KEY is configured by user in Settings UI
```

### Desktop-Specific
```env
TAURI_PRIVATE_KEY=<signing_key>  # For update signing
TAURI_KEY_PASSWORD=<key_password>
```

## 5. Deployment Workflow Rules

### GitHub (Source Control)
- **Main Branch:** The `main` branch is the source of truth for Production.
- **Triggers:** Pushing to the `main` branch automatically triggers a Vercel deployment.
- **PRs:** Feature branches should be merged into `main` via Pull Requests.

### Vercel (Web Frontend)
- **Configuration:** Ensure `vercel.json` (if present) or Project Settings match the build command (`pnpm build:web`).
- **Environment Variables:**
  - NEVER hardcode secrets in the frontend code.
  - Use `VITE_` prefix for client-side variables.
  - Ensure Vercel Project Settings have the correct Production Environment Variables set.

### Tauri (Desktop)
- **Build Command:** `pnpm build:desktop`
- **Package Command:** `pnpm package:desktop`
- **Platforms:** Build for Windows (.msi, .exe), macOS (.dmg, .app), Linux (.deb, .AppImage)
- **Auto-Update:** Configure Tauri updater for automatic updates (SaaS mode)

### Supabase (Backend)
- **Connection:** The frontend connects to Supabase using the Project URL and Anon Key.
- **CORS Configuration:** Ensure Supabase Auth settings allow the following Redirect URLs:
  - `http://localhost:3000/**`
  - `https://www.ace-ielts.net/**`
  - `tauri://localhost/**` (for desktop OAuth)
- **Migrations & SQL Management:**
  - **Source of Truth:** SQL statements and schema definitions in `supabase/migrations/` directory.
  - **Workflow:** Create or edit SQL files within `supabase/migrations/`.
  - **Prohibition:** Do not perform schema changes via Supabase Dashboard SQL Editor for permanent changes.

## 6. Coding Standards for Deployment

### Environment Variable Handling
- **Dynamic URLs:** Do not hardcode `https://www.ace-ielts.net` or `localhost` in fetch/axios calls.
- **Implementation:** Use `packages/core/src/config/` for deployment-specific configuration.

### Deployment Mode Checks
```typescript
// packages/core/src/config/deployment.ts
export type DeploymentMode = "saas" | "self-hosted"

export function getDeploymentMode(): DeploymentMode {
  return (import.meta.env.VITE_DEPLOYMENT_MODE as DeploymentMode) || "self-hosted"
}

export function isSaaSMode(): boolean {
  return getDeploymentMode() === "saas"
}
```

### LLM API Configuration
- **SaaS Mode:** API key managed server-side, users don't see it
- **Self-Hosted Mode:** Provide Settings UI for users to input their own API key
- **Storage:** Self-hosted API keys stored securely (encrypted in local storage or Supabase)

### Feature Flags
```typescript
// Use deployment mode for feature availability
if (isSaaSMode()) {
  // Show subscription/billing features
} else {
  // Show API key configuration
}
```
