---
alwaysApply: true
---
## Platform Adapter Pattern

The adapter pattern enables code sharing across platforms with different runtime APIs.

### Core Adapter Interfaces (defined in `@ace-english/core/adapters`)

```typescript
export type Platform = "web" | "extension"

export interface IStorageAdapter {
  get<T>(key: string): Promise<T | null>
  set<T>(key: string, value: T): Promise<void>
  remove(key: string): Promise<void>
  clear(): Promise<void>
}

export interface INavigationAdapter {
  navigate(path: string): void
  openExternal(url: string): void
  getCurrentPath(): string
  goBack(): void
}

export interface IEnvironmentAdapter {
  getPlatform(): Platform
  isDevelopment(): boolean
  getBaseUrl(): string
  getApiUrl(): string
}

export interface IPlatformContext {
  platform: Platform
  storage: IStorageAdapter
  navigation: INavigationAdapter
  environment: IEnvironmentAdapter
  analytics?: IAnalyticsAdapter
}
```

### Implementation Pattern

**1. Each app implements its own adapters in `src/adapters/`:**

```typescript
// app/extension/src/adapters/storage.ts
export const chromeStorageAdapter: IStorageAdapter = {
  async get<T>(key: string) {
    const result = await chrome.storage.local.get(key)
    return result[key] ?? null
  },
  // ...
}

// app/web/src/adapters/storage.ts
export const webStorageAdapter: IStorageAdapter = {
  async get<T>(key: string) {
    const item = localStorage.getItem(key)
    return item ? JSON.parse(item) : null
  },
  // ...
}
```

**2. Apps create platform context:**

```typescript
// app/extension/src/adapters/index.ts
export const extensionPlatformContext: IPlatformContext = {
  platform: "extension",
  storage: chromeStorageAdapter,
  navigation: chromeNavigationAdapter,
  environment: chromeEnvironmentAdapter
}

// app/web/src/adapters/index.ts
export const webPlatformContext: IPlatformContext = {
  platform: "web",
  storage: webStorageAdapter,
  navigation: webNavigationAdapter,
  environment: webEnvironmentAdapter
}
```

**3. Wrap app with PlatformProvider:**

```tsx
// In app entry point
import { PlatformProvider } from "@ace-english/core"
import { extensionPlatformContext } from "./adapters"

function App() {
  return (
    <PlatformProvider context={extensionPlatformContext}>
      <Dashboard />
    </PlatformProvider>
  )
}
```

**4. Use hooks in shared components:**

```tsx
// In @ace-english/ui pages/components
import { usePlatform, useStorage, useNavigation } from "@ace-english/core"

function MyComponent() {
  const { platform } = usePlatform()
  const storage = useStorage()
  const navigation = useNavigation()
  
  // Works on both platforms!
}
```

---

## Code Placement Rules

### Where to Put New Code

| Code Type | Location | Package |
|-----------|----------|---------|
| TypeScript interfaces/types | `packages/core/src/types/` | `@ace-english/core` |
| API service functions | `packages/core/src/services/` | `@ace-english/core` |
| Custom React hooks | `packages/core/src/hooks/` | `@ace-english/core` |
| i18n translations | `packages/core/src/i18n/locales/` | `@ace-english/core` |
| Utility functions | `packages/core/src/utils/` | `@ace-english/core` |
| shadcn/ui components | `packages/ui/src/components/` | `@ace-english/ui` |
| Layout components | `packages/ui/src/layout/` | `@ace-english/ui` |
| Shared pages | `packages/ui/src/pages/` | `@ace-english/ui` |
| Dashboard widgets | `packages/ui/src/dashboard/` | `@ace-english/ui` |
| Extension popup | `app/extension/src/popup.tsx` | `@ace-english/extension` |
| Extension tabs | `app/extension/src/tabs/` | `@ace-english/extension` |
| Extension background | `app/extension/src/background.ts` | `@ace-english/extension` |
| Web routes/pages | `app/web/src/pages/` | `@ace-english/web` |
| Platform adapters | `app/[platform]/src/adapters/` | App-specific |

### Barrel Export Pattern

Every directory with multiple exports MUST have an `index.ts` barrel file:

```typescript
// packages/ui/src/components/index.ts
export { Button, buttonVariants, type ButtonProps } from "./button"
export { Card, CardHeader, CardContent, ... } from "./card"
export { Progress } from "./progress"
// ... all component exports
```

Update the barrel file whenever adding new modules.

---

## Scripts & Commands

### Root-Level Scripts (run from project root)

```bash
# Development
pnpm dev:web          # Start web dev server (Vite)
pnpm dev:extension    # Start extension dev (Plasmo)

# Build
pnpm build:web        # Build web app
pnpm build:extension  # Build extension
pnpm build:all        # Build all packages

# Quality
pnpm lint             # Lint all packages
pnpm typecheck        # Type-check all packages

# Utilities
pnpm clean            # Clean all build artifacts
pnpm package:extension # Package extension for distribution
```

### Running Commands in Specific Packages

```bash
pnpm --filter @ace-english/core <command>
pnpm --filter @ace-english/ui <command>
pnpm --filter @ace-english/web <command>
pnpm --filter @ace-english/extension <command>
```

---

## TypeScript Configuration

### Base Config (`tsconfig.base.json`)

All packages extend from root `tsconfig.base.json`:

```json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "jsx": "react-jsx",
    "moduleResolution": "bundler",
    "paths": {
      "@ace-english/core": ["packages/core/src"],
      "@ace-english/core/*": ["packages/core/src/*"],
      "@ace-english/ui": ["packages/ui/src"],
      "@ace-english/ui/*": ["packages/ui/src/*"]
    }
  }
}
```

### Package Config Pattern

```json
// packages/*/tsconfig.json
{
  "extends": "../../tsconfig.base.json",
  "include": ["src"]
}

// app/*/tsconfig.json
{
  "extends": "../../tsconfig.base.json",
  "include": ["src"],
  "compilerOptions": {
    // App-specific options
  }
}
```

---

## Adding New Features Checklist

### Adding a New Shared Component

1. Create component in `packages/ui/src/components/NewComponent.tsx`
2. Export from `packages/ui/src/components/index.ts`
3. Import in apps: `import { NewComponent } from "@ace-english/ui"`

### Adding a New Shared Page

1. Create page in `packages/ui/src/pages/NewPage.tsx`
2. Use `usePlatform()` hooks for platform-specific behavior
3. Export from `packages/ui/src/pages/index.ts`
4. Import and wrap in each app with appropriate adapters

### Adding a New Service/API

1. Define types in `packages/core/src/types/`
2. Create service in `packages/core/src/services/`
3. Export from respective `index.ts` files

### Adding a New Platform Adapter

1. Define interface in `packages/core/src/adapters/types.ts`
2. Add to `IPlatformContext` interface
3. Implement in `app/extension/src/adapters/`
4. Implement in `app/web/src/adapters/`
5. Add hook in `packages/core/src/adapters/context.tsx`

---

## Best Practices

### DO:
- ✅ Keep shared code platform-agnostic in `packages/`
- ✅ Use adapter pattern for platform-specific APIs
- ✅ Export everything through barrel files (`index.ts`)
- ✅ Use `workspace:*` for internal dependencies
- ✅ Run `pnpm typecheck` before committing
- ✅ Keep apps as thin wrappers around shared code

### DON'T:
- ❌ Import from `app/*` in `packages/*`
- ❌ Use `chrome.*` APIs directly in shared packages
- ❌ Use `localStorage` directly in shared packages
- ❌ Create circular dependencies
- ❌ Duplicate code between web and extension
- ❌ Use relative imports across package boundaries

---

## Package Manager

This project uses **pnpm** exclusively.

- Required version: `>=8.0.0`
- Node.js version: `>=18.0.0`
- Lock file: `pnpm-lock.yaml` (NEVER delete or modify manually)

```bash
# Install dependencies
pnpm install

# Add dependency to specific package
pnpm --filter @ace-english/ui add <package-name>

# Add dev dependency
pnpm --filter @ace-english/core add -D <package-name>

# Add to root (shared dev tools)
pnpm add -D -w <package-name>
```
